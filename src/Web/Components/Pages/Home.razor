@page "/"
@inject LotteryApiClient LotteryApiClient
@inject ILogger<Home> Logger

<PageTitle>Probabilités Loto & EuroMillions</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="landing-container">
    <MudPaper Elevation="2" Class="hero-panel">
        <MudText Typo="Typo.h3" GutterBottom="true">Probabilités Loto &amp; EuroMillions</MudText>
        <MudText Typo="Typo.subtitle1">
            Plateforme statistique informative pour consulter l'état des données de tirages.
        </MudText>
        <MudStack Row="true" Spacing="1" Class="mt-3">
            <MudPaper Class="tag-pill tag-pill-info" Elevation="0">
                <MudText Typo="Typo.caption">Non affilié à FDJ</MudText>
            </MudPaper>
            <MudPaper Class="tag-pill tag-pill-warning" Elevation="0">
                <MudText Typo="Typo.caption">Jeu responsable</MudText>
            </MudPaper>
        </MudStack>
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true" Class="mt-4">
            Les jeux d'argent comportent des risques : endettement, isolement, dépendance.
            Fixez vos limites et jouez avec modération.
        </MudAlert>
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-2">
            Ce site ne prédit aucun tirage. Les contenus sont purement informatifs et statistiques.
        </MudAlert>

        <MudStack Row="true" Spacing="2" Class="mt-4 hero-actions">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/grilles">
                Générer des grilles
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="/statistiques">
                Voir les statistiques
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Info" Href="/abonnement">
                S'abonner par email
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (!string.IsNullOrWhiteSpace(_messageErreur))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true" Class="mt-4">
            @_messageErreur
        </MudAlert>
    }

    <MudGrid Class="mt-4">
        <MudItem xs="12" md="4">
            <MudPaper Class="kpi-card" Elevation="1">
                <MudText Typo="Typo.overline">Dernière synchronisation</MudText>
                <MudText Typo="Typo.h6">@FormatDateTime(_status.LastSyncAt)</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="kpi-card" Elevation="1">
                <MudText Typo="Typo.overline">Loto</MudText>
                <MudText Typo="Typo.h6">@_status.Loto.DrawsCount tirages</MudText>
                <MudText Typo="Typo.caption">
                    Dernier: @FormatDate(_status.Loto.LastDrawDate) | Prochain: @FormatDate(_status.Loto.NextDrawDate)
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="kpi-card" Elevation="1">
                <MudText Typo="Typo.overline">EuroMillions</MudText>
                <MudText Typo="Typo.h6">@_status.EuroMillions.DrawsCount tirages</MudText>
                <MudText Typo="Typo.caption">
                    Dernier: @FormatDate(_status.EuroMillions.LastDrawDate) | Prochain: @FormatDate(_status.EuroMillions.NextDrawDate)
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="mt-4 disclaimer-panel">
        <MudText Typo="Typo.body2">@_status.Disclaimer</MudText>
    </MudPaper>
</MudContainer>

@code {
    private ApiStatusResponse _status = new();
    private string? _messageErreur;

    protected override async Task OnInitializedAsync()
    {
        var status = await LotteryApiClient.GetStatusAsync(CancellationToken.None);
        if (status is not null)
        {
            _status = status;
            return;
        }

        Logger.LogWarning("Chargement du statut en mode placeholder.");
        _messageErreur = "API indisponible temporairement. Les valeurs affichées sont des valeurs de secours.";
    }

    private static string FormatDate(DateOnly? value)
    {
        if (value is null)
        {
            return "En attente";
        }

        return value.Value.ToString("dd/MM/yyyy");
    }

    private static string FormatDate(DateOnly value) => value.ToString("dd/MM/yyyy");

    private static string FormatDateTime(DateTimeOffset value) =>
        value == DateTimeOffset.MinValue
            ? "En attente"
            : value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss");
}
