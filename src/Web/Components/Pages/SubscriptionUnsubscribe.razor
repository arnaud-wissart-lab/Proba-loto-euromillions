@page "/abonnement/desinscription"
@inject LotteryApiClient LotteryApiClient
@inject ILogger<SubscriptionUnsubscribe> Logger

<PageTitle>Désinscription</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="page-container">
    <MudPaper Elevation="1" Class="section-panel">
        <MudText Typo="Typo.h4" GutterBottom="true">Désinscription</MudText>

        @if (_isLoading)
        {
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
                @_errorMessage
            </MudAlert>
        }
        else if (_result is not null)
        {
            <MudAlert Severity="@(_result.Success ? Severity.Success : Severity.Warning)" Variant="Variant.Outlined" Dense="true">
                @_result.Message
            </MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery(Name = "token")]
    private string? Token { get; set; }

    private bool _isLoading;
    private string? _lastToken;
    private string? _errorMessage;
    private ApiSubscriptionActionResponse? _result;

    protected override async Task OnParametersSetAsync()
    {
        if (string.Equals(_lastToken, Token, StringComparison.Ordinal))
        {
            return;
        }

        _lastToken = Token;
        _errorMessage = null;
        _result = null;

        if (string.IsNullOrWhiteSpace(Token))
        {
            _errorMessage = "Lien invalide: token manquant.";
            return;
        }

        _isLoading = true;
        try
        {
            _result = await LotteryApiClient.UnsubscribeAsync(Token, CancellationToken.None);
            if (_result is null)
            {
                _errorMessage = "La desinscription est indisponible temporairement.";
            }
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Erreur de desinscription abonnement.");
            _errorMessage = "Erreur inattendue pendant la desinscription.";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
